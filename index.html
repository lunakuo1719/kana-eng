<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="apple-touch-icon" href="./nanaicon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>èŒèŒæ–‡æ³•</title>
    <meta name="apple-mobile-web-app-title" content="èŒèŒæ–‡æ³•">

    <style>
        :root {
            --kanahei-pink: #ffcdd2;  
            --kanahei-rose: #f4a8b4; 
            --kanahei-purple: #ce93d8; 
            --kanahei-brown: #6d4c41; 
            --kanahei-cream: #fef4e8;  
            --gold: #fbc02d;
            
            /* --- æ–°è§’è‰²çš„è‰²ç¥¨ --- */
            --nene-gray: #e0e0e0;     /* Ne-Neè²“ */
            --keigo-white: #ffffff;   /* æ•¬èªå…” */
            --capy-brown: #D9A384;    /* æ°´è±šå› */
            --owl-red: #ef5350;       /* çŸ­è€³è²“é ­é·¹ */
            --fox-orange: #ffcc80;    /* ç‹ç‹¸ */
            --bear-brown: #a1887f;    /* å°ç†Š */
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: 700; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom) 15px;
            background: linear-gradient(135deg, var(--kanahei-pink) 0%, #fff0f5 100%); 
            display: flex; flex-direction: column; justify-content: flex-start; align-items: center; min-height: 100vh; overscroll-behavior-y: none;
        }

        .card {
            width: 100%; max-width: 480px; height: 85vh; max-height: 900px; min-height: 600px; margin: auto;
            background-color: #FDF2F0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)), url('./wallpaper/00.jpg'), radial-gradient(#E1B4D3 20%, transparent 20%), radial-gradient(#E1B4D3 20%, transparent 20%);
            background-position: 0 0, center, 0 0, 15px 15px; background-size: cover, cover, 30px 30px, 30px 30px; background-repeat: no-repeat, no-repeat, repeat, repeat;
            border: 5px solid var(--kanahei-brown); border-radius: 40px; padding: 25px; box-shadow: 0px 10px 30px rgba(240, 98, 146, 0.25);
            position: relative; display: flex; flex-direction: column; z-index: 2; overflow-y: auto; overflow-x: hidden;
        }

        /* --- CSS å¯æ„›åœ–æ¡ˆå€ --- */
        .css-icon-base {
            width: 45px; height: 40px; position: relative; flex-shrink: 0; margin-top: 2px;
        }

        /* 1. Ne-Neè²“ */
        .icon-neneneko {
            background: var(--nene-gray); 
            border-radius: 45% 45% 40% 40%;
            height: 32px; width: 38px;
            margin: 8px auto 0;
            position: relative;
        }
        .icon-neneneko::before, .icon-neneneko::after {
            content: ""; position: absolute; top: -6px; width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent;
            border-bottom: 10px solid var(--nene-gray); 
        }
        .icon-neneneko::before { left: 2px; transform: rotate(-15deg); }
        .icon-neneneko::after { right: 2px; transform: rotate(15deg); }
        .neneneko-face {
            position: absolute; top: 12px; left: 50%; margin-left: -7px; 
            width: 4px; height: 4px;
            background: var(--kanahei-brown); border-radius: 50%;
            box-shadow: 10px 0 0 var(--kanahei-brown);
        }
        .neneneko-face::after {
            content: ""; position: absolute; top: 4px; left: 5px; width: 5px; height: 3px;
            border-bottom: 1.5px solid var(--kanahei-brown); border-radius: 50%;
        }

        /* 2. æ•¬èªå…” */
        .icon-keigo {
            background: var(--keigo-white);
            border-radius: 40% 40% 45% 45%;
            height: 30px; width: 34px;
            margin: 8px auto 0;
            position: relative;
        }
        .icon-keigo::before, .icon-keigo::after {
            content: ""; position: absolute; top: -12px; width: 6px; height: 16px;
            background: var(--keigo-white); 
            border-radius: 10px 10px 0 0;
        }
        .icon-keigo::before { left: 8px; }
        .icon-keigo::after { right: 8px; }
        .keigo-face {
            position: absolute; top: 11px; left: 50%; margin-left: -6px;
            width: 3px; height: 3px;
            background: var(--kanahei-brown); border-radius: 50%;
            box-shadow: 9px 0 0 var(--kanahei-brown);
        }
        .keigo-face::after {
            content: ""; position: absolute; top: 5px; left: 4px; width: 4px; height: 2px;
            border-bottom: 1.5px solid var(--kanahei-brown); border-radius: 50%;
        }

        /* 3. æ°´è±šå› */
        .icon-capybara {
            background: var(--capy-brown);
            border-radius: 40% 50% 50% 40%; 
            height: 28px; width: 40px;
            margin: 10px auto 0;
            position: relative;
        }
        .icon-capybara::before {
            content: ""; position: absolute; top: -3px; left: 10px;
            width: 4px; height: 4px; background: var(--capy-brown);
            border-radius: 50%;
            box-shadow: 15px 0 0 var(--capy-brown); 
        }
        .capy-face {
            position: absolute; top: 10px; left: 24px;
            width: 2px; height: 2px; background: var(--kanahei-brown);
            border-radius: 50%;
            box-shadow: 6px 0 0 var(--kanahei-brown);
        }
        .capy-face::after {
            content: ""; position: absolute; top: 3px; left: 8px;
            width: 3px; height: 2px; background: #5d4037; border-radius: 50%;
        }

        /* 4. çŸ­è€³è²“é ­é·¹ */
        .icon-owl {
            background: var(--owl-red);
            border-radius: 45% 45% 40% 40%;
            height: 32px; width: 34px;
            margin: 8px auto 0;
            position: relative;
        }
        .icon-owl::before, .icon-owl::after {
            content: ""; position: absolute; top: -3px; width: 8px; height: 8px;
            background: var(--owl-red); border-radius: 50% 50% 0 0;
        }
        .icon-owl::before { left: 0px; transform: rotate(-10deg); }
        .icon-owl::after { right: 0px; transform: rotate(10deg); }
        .owl-face-white {
            position: absolute; top: 6px; left: 50%; transform: translateX(-50%);
            width: 22px; height: 22px;
            background: white;
            border-radius: 40% 40% 45% 45%;
        }
        .owl-eyes {
            position: absolute; top: 7px; left: 50%; margin-left: -5px;
            width: 4px; height: 4px; 
            background: #3e2723; border-radius: 50%;
            box-shadow: 6px 0 0 #3e2723;
        }
        .owl-eyes::after {
            content: ""; position: absolute; top: 4px; left: 3px;
            width: 0; height: 0; border-left: 2px solid transparent; border-right: 2px solid transparent;
            border-top: 3px solid #ffca28;
        }

        /* 5. ç‹ç‹¸ */
        .icon-fox {
            background: var(--fox-orange);
            border-radius: 50% 50% 45% 45%;
            height: 28px; width: 34px;
            margin: 10px auto 0;
            position: relative;
        }
        .icon-fox::before, .icon-fox::after {
            content: ""; position: absolute; top: -8px; width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 10px solid var(--fox-orange);
        }
        .icon-fox::before { left: 2px; transform: rotate(-15deg); }
        .icon-fox::after { right: 2px; transform: rotate(15deg); }
        .fox-face {
            position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 20px; height: 12px; background: white;
            border-radius: 15px 15px 50% 50%;
        }
        .fox-face::after {
            content: ""; position: absolute; top: -5px; left: 50%; margin-left: -5px;
            width: 3px; height: 3px; 
            background: var(--kanahei-brown); border-radius: 50%;
            box-shadow: 7px 0 0 var(--kanahei-brown), 3.5px 5px 0 var(--kanahei-brown);
        }

        /* 6. å°ç†Š */
        .icon-bear {
            background: var(--bear-brown);
            border-radius: 50% 50% 45% 45%;
            height: 30px; width: 36px;
            margin: 8px auto 0;
            position: relative;
        }
        .icon-bear::before, .icon-bear::after {
            content: ""; position: absolute; top: -4px; width: 8px; height: 8px;
            background: var(--bear-brown); border-radius: 50%;
        }
        .icon-bear::before { left: 2px; }
        .icon-bear::after { right: 2px; }
        .bear-snout {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            width: 14px; height: 10px; background: #d7ccc8; border-radius: 50%;
        }
        .bear-snout::before {
            content: ""; position: absolute; top: -5px; left: 2px;
            width: 3px; height: 3px; 
            background: var(--kanahei-brown); border-radius: 50%;
            box-shadow: 7px 0 0 var(--kanahei-brown);
        }
        .bear-snout::after {
            content: ""; position: absolute; top: 2px; left: 5px;
            width: 4px; height: 3px; background: #5d4037; border-radius: 50%;
        }

        /* 7. è¨˜æ†¶åå¸å› */
        .icon-toast {
            background: #edb46d;
            border-radius: 10px 10px 4px 4px;
            height: 32px; width: 36px;
            margin: 8px auto 0;
            position: relative;
            border-bottom: 3px solid #d68c45;
        }
        .icon-toast::before {
            content: ""; position: absolute; 
            top: 3px; left: 3px;
            width: 30px; height: 26px;
            background: #fff8e1;
            border-radius: 8px 8px 3px 3px;
        }
        .toast-face {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            width: 14px; height: 10px; z-index: 2;
        }
        .toast-face::before, .toast-face::after {
            content: ""; position: absolute; top: 0;
            width: 3px; height: 3px; background: #5d4037; border-radius: 50%;
        }
        .toast-face::before { left: 0; } 
        .toast-face::after { right: 0; }
        .toast-face span {
            position: absolute; top: 1px; left: 50%; margin-left: -3px;
            width: 6px; height: 3px; border-bottom: 2px solid #5d4037; border-radius: 0 0 50% 50%;
        }

        /* --------------------------- */

        #collection-overlay, #win-overlay, #big-img-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 2000; display: none; flex-direction: column; padding: 50px 20px; cursor: pointer; }
        #collection-overlay { background-color: #FDF2F0; background-image: url('./wallpaper/01.jpg'); background-size: cover; overflow-y: auto; cursor: default; }
        #collection-content { background: rgba(255, 255, 255, 0.75); backdrop-filter: blur(8px); border-radius: 35px; padding: 30px 25px; border: 4px solid var(--kanahei-brown); max-width: 600px; margin: 40px auto; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.15), inset 0 0 0 5px rgba(255, 255, 255, 0.5); position: relative; }

        #collection-content h2 { position: relative; display: inline-block; z-index: 1; padding: 5px 20px; color: var(--kanahei-brown); font-size: 28px; margin: 0; text-shadow: 1px 1px 0 #fff; }
        #collection-content h2::before { content: ""; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-2deg); width: 120%; height: 80%; background: rgba(255, 128, 171, 0.6); border-left: 3px dotted #fff; border-right: 3px dotted #fff; z-index: -1; box-shadow: 2px 2px 5px rgba(0,0,0,0.05); }

        .sticker-slot { aspect-ratio: 1; border: 3px solid white; border-radius: 10px; overflow: hidden; background: white; display: flex; align-items: center; justify-content: center; box-shadow: 2px 4px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .sticker-slot:hover { transform: scale(1.05) rotate(2deg); }
        .sticker-slot img { width: 100%; height: 100%; object-fit: contain; }

        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 100% { transform: translate(1px, 1px) rotate(0deg); } }
        @keyframes confetti-fall { 0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
        .confetti { position: absolute; width: 10px; height: 10px; z-index: 2001; animation: confetti-fall 3s linear forwards; }
        
        .main-btn, .btn-choice, #next-q-btn, .home-round-btn { transition: transform 0.1s, box-shadow 0.1s; }
        .main-btn:active, .btn-choice:active, #next-q-btn:active, .home-round-btn:active { transform: scale(0.95) translateY(6px); box-shadow: 0 0 0 var(--kanahei-brown); }

        .main-btn { width: 100%; padding: 15px; font-size: 22px; border-radius: 40px; background: var(--kanahei-rose); color: white; border: 4px solid var(--kanahei-brown); box-shadow: 0 6px 0 var(--kanahei-brown); margin: 8px 0; cursor: pointer; }
        .home-round-btn { position: absolute; top: 20px; right: 20px; z-index: 100; width: 55px; height: 55px; background: white; border: 3px solid var(--kanahei-brown); border-radius: 50% !important; display: flex; justify-content: center; align-items: center; padding: 0; cursor: pointer; box-shadow: 0 4px 0 rgba(109, 76, 65, 0.2); overflow: hidden; }
        .home-round-btn img { width: 100%; height: 100%; object-fit: contain; transform: scale(0.85); }

        #next-q-btn { width: auto; min-width: 160px; align-self: center; margin-top: 20px; padding: 10px 25px; font-size: 22px; background: var(--kanahei-rose); color: white; border: 3px solid var(--kanahei-brown); border-radius: 50px; box-shadow: 0 5px 0 var(--kanahei-brown); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }

        /* ç™½è‰²å°ç®­é ­ */
        .css-arrow {
            display: inline-block; width: 0; height: 0; 
            border-top: 8px solid transparent; border-bottom: 8px solid transparent;
            border-left: 12px solid white; border-radius: 3px; 
            margin-left: 8px; vertical-align: middle;
        }

        .progress-wrapper { display: flex; align-items: center; gap: 15px; margin: 10px 0 10px 0; width: 100%; }
        .progress-container { position: relative; height: 50px; flex-grow: 1; padding: 0 30px; }
        .piske-runner { position: absolute; bottom: 12px; width: 75px; transition: left 0.3s ease-out; transform: translateX(-50%); z-index: 10; }
        .bar-outer { height: 20px; background: var(--kanahei-cream); border: 3px solid var(--kanahei-brown); border-radius: 15px; width: 100%; position: absolute; bottom: 0; left: 0; overflow: hidden; }
        .progress-container .bar-outer { width: calc(100% - 60px); left: 30px; }
        .bar-inner { height: 100%; width: 0%; background: var(--kanahei-rose); transition: width 0.3s ease-out; }

        .q-box { font-size: 26px; color: var(--kanahei-brown); margin-bottom: 45px; text-align: left; line-height: 1.4; min-height: 60px; }
        
        .btn-choice { background: white; margin-bottom: 12px; font-size: 22px; border: 3px solid var(--kanahei-brown); border-radius: 20px; width: 100%; padding: 15px 18px; text-align: left; color: var(--kanahei-brown); box-shadow: 0 5px 0 #ddd; cursor: pointer; line-height: 1.3; }
        .translation-box { background: transparent; padding: 0; font-size: 18px; color: var(--kanahei-brown); margin-top: auto; }
        .hidden { display: none !important; }
        
        /* è»Ÿè»Ÿå°ç­†è¨˜å€å¡Š */
        .daily-tip-box { 
            background: #f3e5f5; 
            border: 3px solid #deb3cf; border-radius: 15px; padding: 15px; margin-bottom: 15px; font-size: 18px; color: var(--kanahei-brown); 
            display: flex; align-items: flex-start; gap: 12px; 
        }

        .speech-bubble { background: #fff; border: 3px solid var(--kanahei-brown); border-radius: 20px; padding: 15px; margin: 10px 10px; position: relative; font-size: 18px; color: var(--kanahei-brown); line-height: 1.5; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .speech-bubble::after { content: ''; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); border-width: 15px 15px 0; border-style: solid; border-color: var(--kanahei-brown) transparent transparent; }

        #big-img-overlay { background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 3000; }
        #big-img-content { max-width: 90%; max-height: 70%; border: 10px solid white; border-radius: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="feedback-overlay" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 999; display: none;">
    <img id="feedback-img" src="./heartna.gif" style="width: 220px;">
</div>

<div id="big-img-overlay" onclick="closeBigImage()">
    <img id="big-img-content" src="">
    <p style="color: white; margin-top: 20px; font-size: 20px;">é»ä¸€ä¸‹ç•«é¢è¿”å›('ï½¥âˆ€ï½¥)b</p>
</div>

<div id="win-overlay" style="background: rgba(255, 255, 255, 0.95); justify-content: center; align-items: center;" onclick="location.reload()">
    <div id="win-speech" class="speech-bubble">æ­£åœ¨æº–å‚™è²¼ç´™...â¤</div>
    <img id="reward-img" style="width: 80%; max-width: 300px; border: 5px solid var(--kanahei-brown); border-radius: 20px; margin: 10px 0;" src="">
    <h1 style="color: var(--kanahei-brown); font-size: 26px;">æ¢éšªå¤§æˆåŠŸï¼Ù©(à¹‘â›á´—â›à¹‘)Û¶ </h1>
    <p style="color: #888; font-size: 16px;">(é»æ“Šç•«é¢é‡æ–°é–‹å§‹)</p>
</div>

<div id="collection-overlay">
    <div id="collection-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h2 style="color: var(--kanahei-brown); font-size: 28px;">æˆ‘çš„æ”¶é›†å†Š</h2>
            <button onclick="document.getElementById('collection-overlay').style.display='none'" style="padding: 8px 20px; border-radius: 15px; border: 3px solid var(--kanahei-brown); background: var(--gold); font-size: 18px; cursor:pointer;">è¿”å›</button>
        </div>
        <div id="album-container" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;"></div>
    </div>
</div>

<div class="card">
    <div id="dashboard">
        <div style="display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-bottom: 15px;">
            <img src="./heade-M.gif" style="width: 40%; max-width: 140px;">
            <img src="./heade_r.gif" style="width: 40%; max-width: 140px;">
        </div>
        <h1 style="color: #CE8467; margin:0 0 15px 0; font-size: 32px; text-align: center;">èŒèŒæ–‡æ³•æ¢éšªéšŠ</h1>
        
        <div class="daily-tip-box">
            <div id="tip-icon-area" class="css-icon-base"></div>
            <div><b>å·å·è·Ÿä½ èªªï¼š</b><br><span id="tip-text">æ­£åœ¨ç¿»å°æŠ„...(ã‚âˆ€ï½¥)</span></div>
        </div>

        <div style="background: #ffe3e6; padding: 15px; border-radius: 25px; border: 3px solid var(--kanahei-brown); margin-bottom: 15px; text-align: center;">
            <p style="font-size:20px; margin:5px 0;">å·²ç†Ÿç·´ï¼š<span id="mastered-count">0</span> | éŒ¯é¡Œæ•¸ï¼š<span id="failed-count">0</span> | è²¼ç´™ï¼š<span id="sticker-count">0</span>/80</p>
        </div>
        <button class="main-btn" onclick="startLevel()">å‡ºç™¼å†’éšªå›‰ï¼(ï¾‰>Ï‰<)ï¾‰</button>
        <button id="retry-btn" class="main-btn" style="background:#95c2de; display:none;" onclick="startRetry()">éŒ¯é¡Œè£œè€ƒã…‡ã……ã…‡</button>
        <button class="main-btn" style="background:#ffc845;" onclick="openAlbum()">æˆ‘çš„æ”¶é›†å†Š~âœ¿</button>
        <p style="text-align: center; margin-top: 15px;"><a href="#" onclick="resetData()" style="color: #999; font-size: 14px;">é‡ç½®ç´€éŒ„</a></p>
    </div>

    <div id="game-zone" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <div style="text-align: center; font-size: 20px; color: var(--kanahei-brown); margin: 5px 0; font-weight: bold;"><span id="mode-text">é–‹å¿ƒæ¢éšªä¸­ï½â™ª</span></div>
        <button class="home-round-btn" onclick="location.reload()"><img src="./backhome.png"></button>
        <div class="progress-wrapper">
            <div class="progress-container">
                <img id="piske-img" src="./cutepi.gif" class="piske-runner">
                <div class="bar-outer"><div class="bar-inner" id="progress-bar"></div></div>
            </div>
            <div style="font-size: 20px; color: var(--kanahei-brown); white-space: nowrap;"><span id="progress-num">0</span> / <span id="total-num">20</span></div>
        </div>
        
        <div style="margin-bottom: 20px;">
            <div id="q-text" class="q-box" style="margin-bottom: 5px;"></div>
            <div id="sos-area" class="hidden" style="text-align: left; margin-bottom: 20px;">
                <button onclick="toggleTrans()" style="background:none; border:none; color:#e91e63; cursor:pointer; font-size:16px; padding:0;">
                    <span style="border-bottom: 2px dashed #e91e63;">(â€¢Ó©â€¢)?? çœ‹ä¸æ‡‚é»æˆ‘</span>
                </button>
                <div id="q-trans" class="hidden" style="color: #555; font-size: 18px; margin-top: 5px; font-weight: normal;"></div>
            </div>
        </div>

        <div id="choices-area" style="flex-grow: 1;"></div>
        <div id="hint-area" class="translation-box hidden"><span id="hint-text"></span></div>
        <button id="next-q-btn" class="hidden" onclick="nextQuestion()">
            ä¸‹ä¸€é—œ GOGOï¼ <span class="css-arrow"></span>
        </button>
    </div>
</div>

<script>
// --- åª½å’ªè«‹æŠŠä½ çš„ 1183 é¡Œè²¼åœ¨ä¸‹é¢ ---
const allQuestions = [
    { q: "This is _______ elephant.", opts: ["a", "an", "the", "X"], a: "an", trans: "é€™æ˜¯ä¸€éš»å¤§è±¡ã€‚(elephant: å¤§è±¡)", note: "ä¸­æ–‡ç¿»è­¯ï¼šé€™æ˜¯ä¸€éš»å¤§è±¡ã€‚" },
    { q: "I _______ a teacher.", opts: ["am", "is", "were", "be"], a: "am", trans: "æˆ‘æ˜¯ä¸€ä½è€å¸«ã€‚(teacher: è€å¸«)", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘æ˜¯ä¸€ä½è€å¸«ã€‚" },
    { q: "His sons _______ good boys.", opts: ["is", "are", "do", "have"], a: "are", trans: "ä»–çš„å…’å­å€‘æ˜¯å¥½ç”·å­©ã€‚(sons: å…’å­å€‘)", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–çš„å…’å­å€‘æ˜¯å¥½ç”·å­©ã€‚" },
    { q: "They _______ cats.", opts: ["is am", "are", "be", "X"], a: "are", trans: "ç‰ å€‘æ˜¯è²“ã€‚(cats: è²“)", note: "ä¸­æ–‡ç¿»è­¯ï¼šç‰ å€‘æ˜¯è²“ã€‚" },
    { q: "The moon _______ yellow.", opts: ["was", "were", "is", "am"], a: "is", trans: "æœˆäº®æ˜¯é»ƒè‰²çš„ã€‚(moon: æœˆäº®)", note: "ä¸­æ–‡ç¿»è­¯ï¼šæœˆäº®æ˜¯é»ƒè‰²çš„ã€‚" },
    { q: "They _______ students.", opts: ["is", "are", "be", "am"], a: "are", trans: "ä»–å€‘æ˜¯å­¸ç”Ÿã€‚(student: å­¸ç”Ÿ)", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–å€‘æ˜¯å­¸ç”Ÿã€‚" },
    { q: "She _______ a doctor.", opts: ["do", "does", "are", "is"], a: "is", trans: "å¥¹æ˜¯ä¸€ä½é†«ç”Ÿã€‚(doctor: é†«ç”Ÿ)", note: "ä¸­æ–‡ç¿»è­¯ï¼šå¥¹æ˜¯ä¸€ä½é†«ç”Ÿã€‚" },
    { q: "He _______ many books.", opts: ["is", "be", "have", "has"], a: "has", trans: "ä»–æœ‰å¾ˆå¤šæ›¸ã€‚(book: æ›¸)", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–æœ‰å¾ˆå¤šæ›¸ã€‚" },
    { q: "We _______ many pens.", opts: ["is", "be", "have", "has"], a: "have", trans: "æˆ‘å€‘æœ‰å¾ˆå¤šç­†ã€‚(pen: ç­†)", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å€‘æœ‰å¾ˆå¤šç­†ã€‚" },
    { q: "A teacher works in a _______.", opts: ["school", "ship", "car", "train"], a: "school", trans: "è€å¸«åœ¨å­¸æ ¡è£¡å·¥ä½œã€‚(work: å·¥ä½œ)", note: "ä¸­æ–‡ç¿»è­¯ï¼šè€å¸«åœ¨å­¸æ ¡è£¡å·¥ä½œã€‚" },
    { q: "Choose the correct sentence:", options: ["I like to play the piano.", "I like play the piano."], a: "I like to play the piano.", trans: "é¸å‡ºæ­£ç¢ºçš„å¥å­ã€‚(æˆ‘å–œæ­¡å½ˆé‹¼ç´)", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘å–œæ­¡å½ˆé‹¼ç´ã€‚æ–‡æ³•é‡é»ï¼šlike å¾Œé¢æ¥å‹•è©éœ€ç”¨ä¸å®šè© to+V æˆ–å‹•åè© V-ing" },
    { q: "Choose the correct sentence:", options: ["He swim every day.", "He swims every day."], a: "He swims every day.", trans: "é¸å‡ºæ­£ç¢ºçš„å¥å­ã€‚(ä»–æ¯å¤©æ¸¸æ³³)", note: "ä¸­æ–‡ç¿»è­¯ï¼šä»–æ¯å¤©æ¸¸æ³³ã€‚æ–‡æ³•é‡é»ï¼šä¸»è©ç‚ºç¬¬ä¸‰äººç¨±å–®æ•¸ Heï¼Œç¾åœ¨å¼ä¸€èˆ¬å‹•è©éœ€åŠ  s" },
    { q: "Choose the correct sentence:", options: ["I not his student.", "I am not his student."], a: "I am not his student.", trans: "é¸å‡ºæ­£ç¢ºçš„å¥å­ã€‚(æˆ‘ä¸æ˜¯ä»–çš„å­¸ç”Ÿ)", note: "ä¸­æ–‡ç¿»è­¯ï¼šæˆ‘ä¸æ˜¯ä»–çš„å­¸ç”Ÿã€‚æ–‡æ³•é‡é»ï¼šè‹±æ–‡å¥å­å¿…é ˆæœ‰å‹•è©ï¼Œbe å‹•è©å¦å®šå¥ç›´æ¥åœ¨å¾Œé¢åŠ  not" },
];

const STICKERS_NORMAL = Array.from({length: 70}, (_, i) => `./stickers/${String(i+1).padStart(2, '0')}.jpg`);
const STICKERS_SPECIAL = Array.from({length: 10}, (_, i) => `./stickers/special/${String(i+1).padStart(2, '0')}.jpg`);

let userData = JSON.parse(localStorage.getItem('kana_v9')) || { mastered: 0, currentLevel: 0, failed_list: [], stickers: [] };
let currentGroup = [];
let totalInGroup = 20;
let isLocked = false;
let isRetryMode = false;
let dialogRotation = 0; 

function init() {
    document.getElementById('mastered-count').innerText = userData.mastered;
    document.getElementById('failed-count').innerText = userData.failed_list.length;
    document.getElementById('sticker-count').innerText = userData.stickers.length;
    document.getElementById('retry-btn').style.display =
        (userData.failed_list.length > 0) ? "inline-block" : "none";

    const tips = [
        "é »ç‡å‰¯è©æ“ºå“ªè£¡ï¼Ÿbeå‹•è©å¾Œã€‚<br>è§£é‡‹ï¼šis always happy (beå¾Œ)",
    ];

    const finalTip = tips[Math.floor(Math.random() * tips.length)];
    document.getElementById('tip-text').innerHTML = finalTip;

    // --- é€™è£¡æ”¹æˆéš¨æ©Ÿå‡ºç¾ï¼šNe-Neè²“ã€æ•¬èªå…”ã€æ°´è±šã€è²“é ­é·¹ã€ç‹ç‹¸ã€å°ç†Šã€è¨˜æ†¶åå¸ ---
    const cssIcons = [
        // 1. Ne-Neè²“ (æ…µæ‡¶ç°è²“)
        `<div class="icon-neneneko"><div class="neneneko-face"></div></div>`,
        // 2. æ•¬èªå…” (èªçœŸç™½å…”)
        `<div class="icon-keigo"><div class="keigo-face"></div></div>`,
        // 3. æ°´è±šå› (ç¶­æŒå´é¢)
        `<div class="icon-capybara"><div class="capy-face"></div></div>`,
        // 4. çŸ­è€³è²“é ­é·¹ (ç´…è‰²çš„Komimizuk)
        `<div class="icon-owl"><div class="owl-face-white"><div class="owl-eyes"></div></div></div>`,
        // 5. ç‹ç‹¸
        `<div class="icon-fox"><div class="fox-face"></div></div>`,
        // 6. å°ç†Š
        `<div class="icon-bear"><div class="bear-snout"></div></div>`,
        // 7. è¨˜æ†¶åå¸å› (æ–°åŠ å…¥)
        `<div class="icon-toast"><div class="toast-face"><span></span></div></div>`
    ];

    const randomIcon = cssIcons[Math.floor(Math.random() * cssIcons.length)];
    document.getElementById('tip-icon-area').innerHTML = randomIcon;
}


function startLevel() {
    isRetryMode = false;
    const startIdx = (userData.currentLevel * 20) % allQuestions.length;
    document.getElementById('mode-text').innerText = (startIdx >= 1063) ? "â˜‘ï¸å°éŒ¯æŒ‘æˆ°å¤§é€²æ“Šï¼" : "æ–‡æ³•å³¶é–‹å¿ƒæ¢éšªä¸­ï½â™«";
    currentGroup = allQuestions.slice(startIdx, startIdx + 20).sort(() => Math.random() - 0.5);
    setupGame();
}

function startRetry() {
    isRetryMode = true;
    document.getElementById('mode-text').innerText = "PåŠ©é™ªä½ è¤‡ç¿’ä¸­...(â€¢Ó©â€¢)";
    currentGroup = [...userData.failed_list].sort(() => Math.random() - 0.5);
    setupGame();
}

function setupGame() {
    totalInGroup = currentGroup.length;
    document.getElementById('total-num').innerText = totalInGroup;
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('game-zone').classList.remove('hidden');
    renderQuestion();
}

function renderQuestion() {
    isLocked = false;
    document.getElementById('next-q-btn').classList.add('hidden');
    
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ é‡ç½®ç¿»è­¯é¡¯ç¤ºç‹€æ…‹ ğŸ‘‡ğŸ‘‡ğŸ‘‡
    document.getElementById('q-trans').classList.add('hidden'); 
    const sosArea = document.getElementById('sos-area');
    
    if (currentGroup.length === 0) return finishLevel();
    const data = currentGroup[0];
    document.getElementById('q-text').innerText = data.q;
    
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ å¦‚æœæœ‰è¨­å®š trans æ‰é¡¯ç¤ºæŒ‰éˆ• ğŸ‘‡ğŸ‘‡ğŸ‘‡
    if (data.trans) {
        sosArea.classList.remove('hidden');
        document.getElementById('q-trans').innerText = "ğŸ’¡ " + data.trans;
    } else {
        sosArea.classList.add('hidden');
    }

    document.getElementById('hint-area').classList.add('hidden');
    const area = document.getElementById('choices-area');
    area.innerHTML = "";
    (data.options || data.opts).forEach(opt => {
        const b = document.createElement('button');
        b.className = "btn-choice"; 
        if (opt.length > 25) { b.style.fontSize = "17px"; b.style.padding = "10px 12px"; }
        b.innerText = opt;
        b.onclick = () => handleSelect(opt, b);
        area.appendChild(b);
    });
    const solved = totalInGroup - currentGroup.length;
    document.getElementById('progress-num').innerText = solved;
    let p = (solved/totalInGroup)*100;
    document.getElementById('progress-bar').style.width = p + "%";
    document.getElementById('piske-img').style.left = p + "%"; 
}

// ğŸ‘‡ğŸ‘‡ğŸ‘‡ ç¿»è­¯åˆ‡æ›åŠŸèƒ½ ğŸ‘‡ğŸ‘‡ğŸ‘‡
function toggleTrans() {
    const transDiv = document.getElementById('q-trans');
    if (transDiv.classList.contains('hidden')) {
        transDiv.classList.remove('hidden');
    } else {
        transDiv.classList.add('hidden');
    }
}

function handleSelect(opt, b) {
    if (isLocked) return;
    isLocked = true;
    const cur = currentGroup[0];
    const hintText = document.getElementById('hint-text');
    let pureNote = (cur.note || "").replace("ä¸­æ–‡ç¿»è­¯ï¼š", "");
    const isCorrect = (opt === cur.a);
    const bossKeywords = ["åè©å­å¥", "åŒä½èª", "é—œä¿‚ä»£åè©", "ä½¿å½¹å‹•è©", "è¢«å‹•èªæ…‹", "å‡è¨­èªæ°£", "å®Œæˆå¼"];
    const isBoss = bossKeywords.some(k => pureNote.includes(k)) || cur.q.length > 55;
    let dialogHtml = "";

    // ğŸ† ä¿®æ”¹ï¼šåªç•™ä¸‹å…”å…”çš„å°è©±æ¡† ğŸ†
    if (!isCorrect) {
        dialogHtml = `
            <div style="display:flex; align-items:flex-end; gap:10px;">
                <img src="./bunny_think.gif" style="width:75px;">
                <div style="background:white; border:3px solid var(--kanahei-pink); border-radius:15px; padding:10px; flex:1;">
                    <span style="color:var(--kanahei-brown);">å“å‘€ï½(Ë˜â€¢Ï‰â€¢Ë˜)å¤ªå¯æƒœäº†æï¼æ­£ç¢ºæ„æ€æ˜¯ã€Œ ${pureNote}å–”ï¼</span>
                </div>
            </div>`;
    } else if (isBoss) {
        dialogHtml = `
            <div style="display:flex; align-items:flex-end; gap:10px;">
                <img src="./bunny_glass.gif" style="width:85px;">
                <div style="background:white; border:3px solid #ff8a80; border-radius:15px; padding:10px; flex:1;">
                    <span style="color:var(--kanahei-brown);">(æ¨çœ¼é¡) å’³ï¼é€™é¡Œæ˜¯å¤§é­”ç‹æï¼è¢«ä½ æ”¶æœäº†ï¼æ„æ€æ˜¯ã€Œ ${pureNote}ï¼</span>
                </div>
            </div>`;
    } else {
        dialogRotation++; const mode = dialogRotation % 3;
        if (mode === 0) { 
            dialogHtml = `
            <div style="display:flex; align-items:flex-end; gap:10px;">
                <img src="./bunny_think.gif" style="width:75px;">
                <div style="background:white; border:3px solid var(--kanahei-pink); border-radius:15px; padding:10px; flex:1;">
                    <span style="color:var(--kanahei-brown);">æ²’éŒ¯ï¼é€™å¥æ˜¯ã€Œ ${pureNote}ï¼ä½ æ€è€ƒçš„æ¨£å­è·Ÿå…”å…”ä¸€æ¨£å¸¥å–”ï¼</span>
                </div>
            </div>`; 
        }
        else if (mode === 1) { 
            dialogHtml = `
            <div style="display:flex; align-items:flex-end; gap:10px;">
                <img src="./bunny_eat.gif" style="width:75px;">
                <div style="background:white; border:3px solid var(--kanahei-pink); border-radius:15px; padding:10px; flex:1;">
                    <span style="color:var(--kanahei-brown);">åš¼åš¼...ä½ å­¸è‹±æ–‡æ¯”å…”å…”åƒè›‹ç³•é‚„å¿«æï¼é€™å¥ç¿»è­¯æ˜¯ã€Œ ${pureNote}å–”ï¼</span>
                </div>
            </div>`; 
        }
        else { 
            dialogHtml = `
            <div style="display:flex; align-items:flex-end; gap:10px;">
                <img src="./bunny_universal.png" style="width:75px;">
                <div style="background:white; border:3px solid var(--kanahei-pink); border-radius:15px; padding:10px; flex:1;">
                    <span style="color:var(--kanahei-brown);">é€™å¥æ„æ€æ˜¯ã€Œ ${pureNote}å“¦ï¼</span>
                </div>
            </div>`; 
        }
    }
    
    hintText.innerHTML = dialogHtml;
    document.getElementById('hint-area').classList.remove('hidden');

    if (isCorrect) {
        b.style.backgroundColor = "#b2cecf";
        if (!isRetryMode) userData.mastered++;
        else userData.failed_list = userData.failed_list.filter(item => item.q !== cur.q);
        currentGroup.shift();
    } else {
        b.style.backgroundColor = "#eceff1"; b.style.color = "#b0bec5"; b.style.borderColor = "#cfd8dc";
        document.querySelectorAll('.btn-choice').forEach(btn => { if (btn.innerText === cur.a) { btn.style.backgroundColor = "var(--kanahei-rose)"; btn.style.color = "white"; } });
        if (!isRetryMode && !userData.failed_list.some(i => i.q === cur.q)) userData.failed_list.push(cur);
        currentGroup.push(currentGroup.shift()); 
    }
    saveData();
    document.getElementById('next-q-btn').classList.remove('hidden');
}

function nextQuestion() { renderQuestion(); }

function finishLevel() {
    const pool = Math.random() < 0.15 ? STICKERS_SPECIAL : STICKERS_NORMAL;
    const winUrl = pool[Math.floor(Math.random() * pool.length)];
    if (!userData.stickers.includes(winUrl)) userData.stickers.push(winUrl);
    
    // åª½å’ªæƒ³è¦çš„éš¨æ©Ÿå°è©±
    const dialogs = [
        "å˜¿å’»...PåŠ©(â€¢Ó©â€¢)å¹«ä½ æŠŠçè²´è²¼ç´™æ¬éä¾†å›‰ï¼å¿«æ”¶ä¸‹æï¼",
        "å“‡ï¼é–ƒé–ƒç™¼å…‰çš„è²¼ç´™ âœ¦ è·Ÿä½ å‰›æ‰èªçœŸç­”é¡Œçš„æ¨£å­ä¸€æ¨£æï¼(â€¢Ì€á´—â€¢Ì)Ùˆ",
        "20é¡Œé”æˆï¼(ï¾‰>Ï‰<)ï¾‰å‘€å¼ï½å¿«æŠŠè²¼ç´™è²¼åˆ°æœ¬æœ¬è£¡ï¼Œå…”å…”å¥½ç¾¨æ…•å–”~æï¼",
        "(å¸æ°£) é€™å¼µè²¼ç´™æœ‰æ·¡æ·¡è‰è“é¦™å‘³æ...æ˜¯åŠªåŠ›çš„çå‹µå–”ï¼ (á•‘á—¢á“«âˆ—)",
        `ç¬¬ ${userData.stickers.length} å¼µè²¼ç´™é”æˆï¼d(ï½¥âˆ€ï½¥)bé›¢è‹±æ–‡åšå£«æ›´è¿‘äº†å“©ï¼æï¼`,
    ];
    
    document.getElementById('win-speech').innerHTML = `<img src="./bunny_piske_come on.gif" style="width:75px; display:block; margin:0 auto 10px;"> ${dialogs[Math.floor(Math.random() * dialogs.length)]}`;
    document.getElementById('reward-img').src = winUrl;
    createConfetti(); 
    document.getElementById('win-overlay').style.display = "flex";
    if (!isRetryMode) userData.currentLevel++;
    saveData();
}

function createConfetti() {
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = ['#ff80ab', '#ffcdd2', '#ce93d8', '#fbc02d'][Math.floor(Math.random() * 4)];
        confetti.style.animationDelay = Math.random() * 2 + 's';
        confetti.style.width = confetti.style.height = (Math.random() * 10 + 5) + 'px';
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4000);
    }
}

function openAlbum() {
    const container = document.getElementById('album-container');
    container.innerHTML = "";
    [...STICKERS_NORMAL, ...STICKERS_SPECIAL].forEach((url) => {
        const hasIt = userData.stickers.includes(url);
        const item = document.createElement('div');
        item.className = "sticker-slot";
        if (hasIt) { item.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:contain;">`; item.onclick = (e) => { e.stopPropagation(); showBigImage(url); } }
        else { item.innerHTML = `<span style="color:#ffc1e3;font-size:24px;">?</span>`; }
        container.appendChild(item);
    });
    document.getElementById('collection-overlay').style.display = "flex";
}

function showBigImage(url) { document.getElementById('big-img-content').src = url; document.getElementById('big-img-overlay').style.display = 'flex'; }
function closeBigImage() { document.getElementById('big-img-overlay').style.display = 'none'; }
function saveData() { localStorage.setItem('kana_v9', JSON.stringify(userData)); }
function resetData() { if(confirm("ç¢ºå®šè¦é‡ç½®ç´€éŒ„å—ï¼Ÿ")) { localStorage.removeItem('kana_v9'); location.reload(); } }
init();
</script>
</body>
</html>
